#!/bin/bash
#
# This is a shell script for managing
# LAMP (Linux + Apache + MariaDB + PHP) environment
#
# Supported OS:
#   - Enterprise Linux 8/9/10 (CentOS Stream, RHEL, Rocky Linux, AlmaLinux, Oracle Linux)
#   - Debian 11/12/13
#   - Ubuntu 20.04/22.04/24.04
#
# Copyright (C) 2013 - 2026 Teddysun <i@teddysun.com>
set -uo pipefail
shopt -s inherit_errexit 2>/dev/null || true
trap _exit INT QUIT TERM

_red() {
    printf '\033[1;31;31m%b\033[0m' "$1"
}

_green() {
    printf '\033[1;31;32m%b\033[0m' "$1"
}

_yellow() {
    printf '\033[1;31;33m%b\033[0m' "$1"
}

_printargs() {
    printf -- "%s" "[$(date)] "
    printf -- "%s" "$1"
    printf "\n"
}

_info() {
    _printargs "$@"
}

_warn() {
    printf -- "%s" "[$(date)] "
    _yellow "$1"
    printf "\n"
}

_error() {
    printf -- "%s" "[$(date)] "
    _red "$1"
    printf "\n"
    exit 2
}

_exit() {
    printf "\n"
    _red "$0 has been terminated."
    printf "\n"
    exit 1
}

# Check if a command exists
_exists() {
    command -v "$1" &>/dev/null
}

_error_detect() {
    local cmd="$1"
    _info "${cmd}"
    if ! eval "${cmd}" 1>/dev/null; then
        _error "Executing command (${cmd}) failed. Please check it and try again."
    fi
}

_sleep_sec() {
    local seconds=$1
    while [[ "${seconds}" -ge "0" ]]; do
      echo -ne "\r     \r"
      _green "${seconds}"
      seconds=$((seconds - 1))
      sleep 1
    done
    echo -ne "\r"
}

# Get OS ID from /etc/os-release
_get_os_id() {
    if [[ -f /etc/os-release ]]; then
        awk -F= '/^ID=/{gsub(/"/, ""); print $2}' /etc/os-release
    fi
}

# Check OS type
_check_sys() {
    local os_type="$1"
    local os_id
    os_id=$(_get_os_id)
    case "${os_type}" in
        rhel)
            [[ "${os_id}" =~ ^(centos|rhel|rocky|almalinux|ol|fedora)$ ]] || \
            [[ -f /etc/redhat-release ]]
            ;;
        debian)
            [[ "${os_id}" == "debian" ]]
            ;;
        ubuntu)
            [[ "${os_id}" == "ubuntu" ]]
            ;;
        *)
            return 1
            ;;
    esac
}

_check_email() {
    local regex="^[a-z0-9!#\$%&'*+/=?^_\`{|}~-]+(\.[a-z0-9!#$%&'*+/=?^_\`{|}~-]+)*@([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z0-9]([a-z0-9-]*[a-z0-9])?\$"
    if [[ ${1} =~ ${regex} ]]; then
        return 0
    else
        return 1
    fi
}

#==============================================================================
# Input Validation Helpers
#==============================================================================
_validate_input() {
    local input="$1"
    local name="$2"
    local pattern="${3:-}"
    local check_exists="${4:-}"
    local exists_path="${5:-}"

    if [[ -z "${input}" ]]; then
        _red "${name} cannot be empty.\n"
        return 1
    fi
    if [[ "${input}" =~ [[:space:]] ]]; then
        _red "${name} cannot contain spaces.\n"
        return 1
    fi
    if [[ -n "${pattern}" && ! "${input}" =~ ${pattern} ]]; then
        _red "${name} is invalid.\n"
        return 1
    fi
    if [[ "${check_exists}" == "file" && -f "${exists_path}${input}.conf" ]]; then
        _red "${name} ${input} already exists.\n"
        return 1
    fi
    return 0
}

_read_validated() {
    local prompt="$1"
    local name="$2"
    local pattern="${3:-}"
    local check_exists="${4:-}"
    local exists_path="${5:-}"
    local var_name="$6"
    local is_secret="${7:-}"
    local default_value="${8:-}"

    local input
    while true; do
        if [[ "${is_secret}" == "secret" ]]; then
            read -s -r -p "${prompt}" input
            echo
        else
            read -r -p "${prompt}" input
        fi

        # Use default if input is empty
        if [[ -z "${input}" && -n "${default_value}" ]]; then
            printf -v "${var_name}" '%s' "${default_value}"
            return 0
        fi

        if _validate_input "${input}" "${name}" "${pattern}" "${check_exists}" "${exists_path}"; then
            printf -v "${var_name}" '%s' "${input}"
            return 0
        fi
    done
}

#==============================================================================
# Command Routing with Case-Insensitive Matching
#==============================================================================
vhost() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        add)
            add_vhost
            ;;
        list)
            list_vhost
            ;;
        del)
            del_vhost
            ;;
        *)
            _error "Usage: lamp vhost [add|list|del]"
            ;;
    esac
}

database() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        add)
            add_database_menu
            add_database
            ;;
        list)
            list_database
            ;;
        del)
            del_database
            ;;
        edit)
            edit_database
            ;;
        *)
            _error "Usage: lamp db [add|list|del|edit]"
            ;;
    esac
}

#==============================================================================
# Virtual Host Management
#==============================================================================
add_vhost() {
    local domain email vhostdir create_database

    # Domain input with validation
    _read_validated \
        "[$(date)] Please input a domain (example: www.lamp.sh): " \
        "Domain name" \
        '^[a-zA-Z0-9][-a-zA-Z0-9.]*[a-zA-Z0-9]$' \
        "file" \
        "${vhost_dir}/" \
        "domain"

    _info "Domain name: $(_green "${domain}")"

    # Email input
    while true; do
        read -r -p "[$(date)] Please enter Administrator Email address: " email
        if [[ -z "${email}" ]]; then
            _red "Error: Administrator Email address cannot be empty.\n"
        elif _check_email "${email}"; then
            _info "Administrator Email address: ${email}"
            break
        else
            _red "Error: ${email} is not a valid email address.\n"
        fi
    done

    # Virtual Host directory input
    _read_validated \
        "[$(date)] Please input a directory for domain ${domain} (default: /data/www/${domain}): " \
        "Directory" \
        '^/' \
        "" "" \
        "vhostdir" \
        "" \
        "/data/www/${domain}"

    _info "Virtual host directory: $(_green "${vhostdir}")"

    read -r -p "[$(date)] Create a MariaDB database and a user with same name (y/n): " create_database
    if [[ "${create_database}" =~ ^[Yy]$ ]]; then
        verify_db_password
        add_database_menu
    fi

    add_vhost_config "${domain}" "${email}" "${vhostdir}"
    _info "Create Virtual Host directory"
    _error_detect "mkdir -p ${vhostdir}"
    _info "Create Virtual Host log directory"
    _error_detect "mkdir -p /data/wwwlog/${domain}"

    if [[ "${create_database}" =~ ^[Yy]$ ]]; then
        add_database
    fi

    _info "Virtual Host Information:"
    _info "Domain Name: $(_green "${domain}")"
    _info "Virtual Host directory: $(_green "${vhostdir}")"
    _info "Virtual Host log directory: $(_green "/data/wwwlog/${domain}")"
    _info "Virtual Host config file: $(_green "${vhost_dir}/${domain}.conf")"

    list_vhost

    if [[ "${create_database}" =~ ^[Yy]$ ]]; then
        # shellcheck disable=SC2154
        _info "Database username: ${database_name}"
        _info "Database userpassword: ${mysql_password}"
        _info "Database name: ${database_name}"
    fi

    _info "Reloading the Apache config file..."
    _error_detect "systemctl restart ${apache_service}"

    read -r -p "[$(date)] Do you want to add an SSL certificate? [y/n]: " create_ssl
    if [[ "${create_ssl}" =~ ^[Yy]$ ]]; then
        add_ssl_menu "${domain}"
        add_ssl_cert "${domain}" "${email}" "${vhostdir}"
        _info "Reloading the Apache config file..."
        if ${apache_cmd} -t >/dev/null 2>&1; then
            _error_detect "systemctl restart ${apache_service}"
            _info "Reloaded successfully"
        else
            _error "Error: Reload failed. Apache config file had an error, please fix it and try again"
        fi
    else
        _info "You have chosen not to add an SSL certificate"
    fi

    _info "Set permissions of Virtual Host directory"
    _error_detect "chown -R ${web_user}:${web_group} ${vhostdir} /data/wwwlog/${domain}"
    _info "All done"
}

add_ssl_menu() {
    local domain="$1"

    _info "$(_green "1"). Use your own SSL Certificate and Key"
    _info "$(_green "2"). Use Let's Encrypt CA to create SSL Certificate and Key"
    _info "$(_green "3"). Use Buypass.com CA to create SSL Certificate and Key"

    while true; do
        read -r -p "[$(date)] Please enter 1 or 2 or 3: " ssl_pick
        case "${ssl_pick}" in
            1)
                while true; do
                    read -r -p "[$(date)] Please enter full path to SSL Certificate file: " ssl_certificate
                    if [[ -z "${ssl_certificate}" ]]; then
                        _info "$(_red "Error: SSL Certificate file cannot be empty")"
                    elif [[ -s "${ssl_certificate}" ]]; then
                        break
                    else
                        _info "$(_red "Error: ${ssl_certificate} does not exist or is not a file")"
                    fi
                done
                while true; do
                    read -r -p "[$(date)] Please enter full path to SSL Certificate Key file: " ssl_certificate_key
                    if [[ -z "${ssl_certificate_key}" ]]; then
                        _info "$(_red "Error: SSL Certificate Key file cannot be empty")"
                    elif [[ -s "${ssl_certificate_key}" ]]; then
                        break
                    else
                        _info "$(_red "Error: ${ssl_certificate_key} does not exist or is not a file")"
                    fi
                done
                break
                ;;
            2)
                _info "You have chosen Let's Encrypt CA. It will be processed automatically"
                break
                ;;
            3)
                _info "You have chosen Buypass.com CA. It will be processed automatically"
                break
                ;;
            *)
                _info "$(_red "Error: Please only enter 1 or 2 or 3")"
                ;;
        esac
    done

    read -r -p "[$(date)] Do you want to force redirection from HTTP to HTTPS? [y/n]: " force_ssl
    if [[ "${force_ssl}" =~ ^[Yy]$ ]]; then
        _info "You have chosen to force redirection from HTTP to HTTPS. It will be processed automatically"
    else
        _info "You have chosen not to force redirection from HTTP to HTTPS"
    fi
}

add_vhost_config() {
    local domain="$1"
    local email="$2"
    local vhostdir="$3"

    cat > "${vhost_dir}/${domain}.conf" <<EOF
<VirtualHost *:80>
    ServerAdmin ${email}
    ServerName ${domain}
    DocumentRoot ${vhostdir}
    <Directory ${vhostdir}>
        SetOutputFilter DEFLATE
        Options FollowSymLinks
        AllowOverride All
        Order Deny,Allow
        Require all granted
        DirectoryIndex index.html index.htm index.php
    </Directory>
    ErrorLog /data/wwwlog/${domain}/error.log
    CustomLog /data/wwwlog/${domain}/access.log combined
</VirtualHost>
EOF
}

create_ssl_config() {
    local domain="$1"
    local email="$2"
    local vhostdir="$3"
    local ssl_certificate="$4"
    local ssl_certificate_key="$5"

    cat >> "${vhost_dir}/${domain}.conf" <<EOF
<VirtualHost *:443>
    ServerAdmin ${email}
    DocumentRoot ${vhostdir}
    ServerName ${domain}
    SSLEngine on
    SSLCertificateFile ${ssl_certificate}
    SSLCertificateKeyFile ${ssl_certificate_key}
    <Directory ${vhostdir}>
        SetOutputFilter DEFLATE
        Options FollowSymLinks
        AllowOverride All
        Order Deny,Allow
        Require all granted
        DirectoryIndex index.html index.htm index.php
    </Directory>
    Header always set Strict-Transport-Security "max-age=31536000; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    ErrorLog  /data/wwwlog/${domain}/ssl_error.log
    CustomLog  /data/wwwlog/${domain}/ssl_access.log combined
</VirtualHost>
EOF
}

create_ssl_htaccess() {
    local vhostdir="$1"

    cat > "${vhostdir}/.htaccess" <<EOF
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R,L]
</IfModule>
EOF
}

#==============================================================================
# SSL Certificate Functions
#==============================================================================
cleanup_existing_cert() {
    local domain="$1"

    if [[ -d "${ssl_dir}/${domain}" ]]; then
        _info "Removing existing domain certificate..."
        rm -rf "${ssl_dir:?}/${domain}"
    fi
    if [[ -d "${ssl_dir}/${domain}_ecc" ]]; then
        _info "Removing existing domain certificate..."
        rm -rf "${ssl_dir:?}/${domain}_ecc"
    fi
}

install_acme_sh() {
    if [[ -s "/usr/local/acme.sh/acme.sh" ]]; then
        _info "/usr/local/acme.sh/acme.sh [found]"
    else
        wget --no-check-certificate -qO- https://github.com/acmesh-official/acme.sh/tarball/master | tar xz
        cd acmesh-* || _error "Failed to download acme.sh. Please check and try again"
        ./acme.sh --install --log --home /usr/local/acme.sh --certhome "${ssl_dir}"
        cd .. && rm -rf acmesh-*
        # shellcheck disable=SC2016
        sed -i 's/cat "\$CERT_PATH"$/#cat "\$CERT_PATH"/g' /usr/local/acme.sh/acme.sh
        cat >/usr/local/acme.sh/upgrade.sh <<EOF
#!/bin/bash

. /usr/local/acme.sh/acme.sh.env
/usr/local/acme.sh/acme.sh --upgrade
sed -i 's/cat "\\\$CERT_PATH"\$/#cat "\\\$CERT_PATH"/g' /usr/local/acme.sh/acme.sh
EOF
        chmod +x /usr/local/acme.sh/upgrade.sh
        if crontab -l | grep -q "/usr/local/acme.sh/upgrade.sh"; then
            _info "acme.sh upgrade crontab rule already exists"
        else
            (crontab -l ; echo '0 3 */7 * * /usr/local/acme.sh/upgrade.sh') | crontab -
            _info "Created cron job for automatic acme.sh upgrade successfully"
        fi
    fi
}

process_ssl_result() {
    local domain="$1"
    local ca_name="$2"

    if [[ -s "${ssl_dir}/${domain}/fullchain.cer" ]]; then
        ssl_certificate="${ssl_dir}/${domain}/fullchain.cer"
        ssl_certificate_key="${ssl_dir}/${domain}/${domain}.key"
    fi
    if [[ -s "${ssl_dir}/${domain}_ecc/fullchain.cer" ]]; then
        ssl_certificate="${ssl_dir}/${domain}_ecc/fullchain.cer"
        ssl_certificate_key="${ssl_dir}/${domain}_ecc/${domain}.key"
    fi
    _info "Created ${ca_name} SSL Certificate successfully"
}

add_letsencrypt() {
    local domain="$1"
    local vhostdir="$2"
    local letsdomain="$3"

    cleanup_existing_cert "${domain}"
    _info "Starting create Let's Encrypt SSL Certificate..."
    # shellcheck disable=SC1091
    . /usr/local/acme.sh/acme.sh.env
    if /usr/local/acme.sh/acme.sh --issue --server letsencrypt "${letsdomain}" -w "${vhostdir}"; then
        process_ssl_result "${domain}" "Let's Encrypt"
    else
        _error "Error: Create Let's Encrypt SSL Certificate failed"
    fi
}

add_buypass() {
    local domain="$1"
    local vhostdir="$2"
    local letsdomain="$3"
    local email="$4"

    cleanup_existing_cert "${domain}"
    _info "Starting create Buypass.com SSL Certificate..."
    # shellcheck disable=SC1091
    . /usr/local/acme.sh/acme.sh.env
    if /usr/local/acme.sh/acme.sh -m "${email}" --issue --server buypass "${letsdomain}" -w "${vhostdir}" --days 170; then
        process_ssl_result "${domain}" "Buypass.com"
    else
        _error "Error: Create Buypass.com SSL Certificate failed"
    fi
}

add_ssl_cert() {
    local domain="$1"
    local email="$2"
    local vhostdir="$3"

    if [[ -z "${email}" ]] || [[ -z "${vhostdir}" ]]; then
        _error "Error: parameters must be specified"
    fi
    if [[ ! -d "${vhostdir}" ]]; then
        _error "Error: ${vhostdir} does not exist or is not a directory"
    fi

    local letsdomain="-d ${domain}"
    install_acme_sh

    case "${ssl_pick}" in
        2)
            add_letsencrypt "${domain}" "${vhostdir}" "${letsdomain}"
            ;;
        3)
            add_buypass "${domain}" "${vhostdir}" "${letsdomain}" "${email}"
            ;;
    esac

    create_ssl_config "${domain}" "${email}" "${vhostdir}" "${ssl_certificate}" "${ssl_certificate_key}"
    [[ "${force_ssl}" =~ ^[Yy]$ ]] && create_ssl_htaccess "${vhostdir}"
    _info "Added SSL certificate for virtual host [$(_green "${domain}")] successfully"
}

list_vhost() {
    _info "Apache virtual host list:"
    local vhosts=()
    while IFS=' ' read -r line; do vhosts+=("${line}"); done < <(find "${vhost_dir}/" -name "*.conf" -type f -printf "%f\n" | sed 's/.conf//g' | grep -v "default")
    if [[ "${#vhosts[@]}" -gt 0 ]]; then
        for i in "${vhosts[@]}"; do
            _info "  $(_green "${i}")"
        done
    else
        _info "No Apache virtual host found. You can create a new Apache virtual host using the command: $(_green "lamp vhost add")"
    fi
}

del_vhost() {
    list_vhost

    local domain
    _read_validated \
        "[$(date)] Please enter a domain you want to delete: " \
        "Domain name" \
        '^[a-zA-Z0-9][-a-zA-Z0-9.]*[a-zA-Z0-9]$' \
        "" "" \
        "domain"

    _info "Domain name: $(_green "${domain}")"

    if [[ -f "${vhost_dir}/${domain}.conf" ]]; then
        local vhostdir
        vhostdir=$(grep "DocumentRoot" "${vhost_dir}/${domain}.conf" | tail -n1 | awk '{print $2}')
        _error_detect "rm -f ${vhost_dir}/${domain}.conf"
        _info "Domain $(_red "${domain}") has been deleted."
        if [[ -n "${vhostdir}" ]]; then
            _info "Website directory $(_red "${vhostdir}") will not be deleted for security reasons."
        else
            _info "Website directory will not be deleted for security reasons."
        fi
        _info "You need to manually delete the website files."
        systemctl restart "${apache_service}" >/dev/null 2>&1
    else
        _error "Domain: ${domain} does not exist."
    fi
}

#==============================================================================
# Database Management
#==============================================================================
make_temp_mycnf() {
    cat >/tmp/.my.cnf <<EOF
[client]
host     = localhost
user     = root
password = '$1'
EOF
    chmod 600 /tmp/.my.cnf
}

clean_temp_mycnf() {
    [[ -s "/tmp/.my.cnf" ]] && rm -f /tmp/.my.cnf
    [[ -s "/tmp/.mysql.tmp" ]] && rm -f /tmp/.mysql.tmp
}

# Execute SQL with success/failure messages
run_sql() {
    local sql_content="$1"
    local success_msg="$2"
    local fail_msg="$3"

    echo "${sql_content}" >/tmp/.mysql.tmp
    chmod 600 /tmp/.mysql.tmp

    if /usr/bin/mariadb --defaults-file="/tmp/.my.cnf" </tmp/.mysql.tmp >/dev/null 2>&1; then
        _info "${success_msg}"
    else
        _info "${fail_msg}"
    fi
}

do_query() {
    echo "$1" >/tmp/.mysql.tmp
    chmod 600 /tmp/.mysql.tmp
    /usr/bin/mariadb --defaults-file="/tmp/.my.cnf" </tmp/.mysql.tmp
    return $?
}

verify_db_password() {
    local status=1
    while [[ ${status} -eq 1 ]]; do
        read -s -r -p "[$(date)] Please input current root password of Database (password will not shown): " db_root_password
        echo
        if ! /usr/bin/mariadb -uroot -p"${db_root_password}" -e "exit" >/dev/null 2>&1; then
            _red "MariaDB root password is incorrect, Please check it and try again.\n"
        fi
        make_temp_mycnf "${db_root_password}"
        do_query "exit"
        status=$?
    done
}

enter_database_name() {
    _read_validated \
        "[$(date)] Please input database name: " \
        "Database name" \
        "" "" "" \
        "database_name"
}

add_database_menu() {
    enter_database_name
    _info "You will create a MariaDB database and a user with the same name: $(_green "${database_name}")"

    local password_input
    read -s -r -p "[$(date)] Please input password for MariaDB user ${database_name} (password will not shown): " password_input
    mysql_password="${password_input:-${database_name}}"
    echo
    _info "MariaDB database $(_green "${database_name}")'s password: ${mysql_password}"
}

add_database() {
    local sql_content
    sql_content=$(cat <<EOF
CREATE USER '${database_name}'@'localhost' IDENTIFIED BY '${mysql_password}';
CREATE USER '${database_name}'@'127.0.0.1' IDENTIFIED BY '${mysql_password}';
GRANT USAGE ON *.* TO '${database_name}'@'localhost' IDENTIFIED BY '${mysql_password}';
GRANT USAGE ON *.* TO '${database_name}'@'127.0.0.1' IDENTIFIED BY '${mysql_password}';
CREATE DATABASE IF NOT EXISTS \`${database_name}\`;
GRANT ALL PRIVILEGES ON \`${database_name}\`.* TO '${database_name}'@'localhost';
GRANT ALL PRIVILEGES ON \`${database_name}\`.* TO '${database_name}'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF
)
    run_sql "${sql_content}" \
        "Added database $(_green "${database_name}") successfully." \
        "Failed to add database $(_red "${database_name}")."
}

list_database() {
    if /usr/bin/mariadb --defaults-file="/tmp/.my.cnf" -e "SHOW DATABASES;"; then
        _info "Listed all databases successfully."
    else
        _info "Failed to list all databases."
    fi
}

del_database() {
    list_database
    enter_database_name

    if [[ "${database_name}" =~ ^(information_schema|mysql|performance_schema|sys)$ ]]; then
        _error "MariaDB system database $(_red "${database_name}") cannot be deleted."
    fi

    _info "You will delete a MariaDB database and a user with the same name: ${database_name}"
    _info "Wait 10 seconds, Press Ctrl+c to cancel ..."
    _sleep_sec 10

    local sql_content
    sql_content=$(cat <<EOF
DROP USER '${database_name}'@'127.0.0.1';
DROP USER '${database_name}'@'localhost';
DROP DATABASE IF EXISTS \`${database_name}\`;
FLUSH PRIVILEGES;
EOF
)
    run_sql "${sql_content}" \
        "Deleted database $(_green "${database_name}") successfully." \
        "Failed to delete database $(_red "${database_name}")."
}

edit_database() {
    local database_username
    _read_validated \
        "[$(date)] Please input database username: " \
        "Database username" \
        "" "" "" \
        "database_username"

    local database_username_passwd
    _read_validated \
        "[$(date)] Please input NEW password (password will not shown): " \
        "NEW password" \
        "" "" "" \
        "database_username_passwd" \
        "secret"

    local sql_content
    sql_content=$(cat <<EOF
SET PASSWORD FOR '${database_username}'@'127.0.0.1' = PASSWORD('${database_username_passwd}');
SET PASSWORD FOR '${database_username}'@'localhost' = PASSWORD('${database_username_passwd}');
FLUSH PRIVILEGES;
EOF
)
    run_sql "${sql_content}" \
        "Updated password for user $(_green "${database_username}") successfully." \
        "Failed to update password for user $(_red "${database_username}")."
}

#==============================================================================
# Service Management
#==============================================================================
manage_services() {
    local action="$1"  # start, stop, status
    local label="$2"   # Starting, Stopping, Checking

    _info "${label} LAMP..."
    local services=("${apache_service}" "mariadb" "${php_fpm}")

    for svc in "${services[@]}"; do
        case "${action}" in
            start)
                _error_detect "systemctl start ${svc}"
                ;;
            stop)
                _error_detect "systemctl stop ${svc}"
                ;;
            status)
                _info "systemctl status ${svc}"
                systemctl --no-pager -l status "${svc}" || true
                echo
                ;;
        esac
    done

    [[ "${action}" != "status" ]] && _info "${label} LAMP completed"
}

lamp_start() {
    manage_services "start" "Starting"
}

lamp_stop() {
    manage_services "stop" "Stopping"
}

lamp_restart() {
    manage_services "stop" "Stopping"
    sleep 1
    manage_services "start" "Starting"
}

lamp_status() {
    manage_services "status" "Checking"
}

lamp_version() {
    _info "$(_green "Apache") version:"
    ${apache_cmd} -V
    echo
    _info "$(_green "MariaDB") version:"
    /usr/bin/mariadb --version
    echo
    _info "$(_green "PHP") version:"
    /usr/bin/php -v
}

#==============================================================================
# Environment Setup
#==============================================================================
check_env() {
    if _check_sys rhel; then
        apache_service="httpd"
        apache_cmd="/usr/sbin/httpd"
        vhost_dir="/etc/httpd/conf.d/vhost"
        ssl_dir="/etc/httpd/ssl"
        web_user="apache"
        web_group="apache"
        php_fpm="php-fpm"
    elif _check_sys debian || _check_sys ubuntu; then
        apache_service="apache2"
        apache_cmd="/usr/sbin/apache2"
        vhost_dir="/etc/apache2/sites-enabled"
        ssl_dir="/etc/apache2/ssl"
        web_user="www-data"
        web_group="www-data"
        # shellcheck disable=SC1091
        [[ -f "/etc/apache2/envvars" ]] && . /etc/apache2/envvars
        local php_ver
        php_ver="$(/usr/bin/php -v | head -n1 | awk '{print $2}' | cut -d. -f1-2)"
        php_fpm="php${php_ver}-fpm"
    else
        _error "Unsupported OS. Please use Enterprise Linux 8+, Debian 11+, or Ubuntu 20.04+"
    fi
}

#==============================================================================
# Usage Information
#==============================================================================
show_usage() {
    _info "Usage:"
    _info "  $(_green "lamp start")      Start all of LAMP services"
    _info "  $(_green "lamp stop")       Stop all of LAMP services"
    _info "  $(_green "lamp restart")    Restart all of LAMP services"
    _info "  $(_green "lamp status")     Check all of LAMP services status"
    _info "  $(_green "lamp version")    Print all LAMP software versions"
    _info "  $(_green "lamp vhost add")  Create a new Apache virtual host"
    _info "  $(_green "lamp vhost list") List all of Apache virtual hosts"
    _info "  $(_green "lamp vhost del")  Delete a Apache virtual host"
    _info "  $(_green "lamp db add")     Create a MariaDB database and a user with same name"
    _info "  $(_green "lamp db list")    List all of MariaDB databases"
    _info "  $(_green "lamp db del")     Delete a MariaDB database and a user with same name"
    _info "  $(_green "lamp db edit")    Update a MariaDB database username's password"
}

#==============================================================================
# Main Entry Point
#==============================================================================
main() {

    # Check user
    if [[ ${EUID} -ne 0 ]]; then
        _red "This script must be run as root!\n"
        exit 1
    fi

    local arg1="${1:-}"
    local arg2="${2:-}"

    _info "+-------------------------------------------+"
    _info "|    Manager for LAMP, Written by Teddysun  |"
    _info "+-------------------------------------------+"
    _info "|    $(_green "https://github.com/teddysun/lamp")       |"
    _info "+-------------------------------------------+"

    check_env

    case "$(echo "${arg1}" | tr '[:upper:]' '[:lower:]')" in
        start)
            lamp_start
            ;;
        stop)
            lamp_stop
            ;;
        restart)
            lamp_restart
            ;;
        status)
            lamp_status
            ;;
        version)
            lamp_version
            ;;
        vhost)
            vhost "${arg2}"
            ;;
        db)
            verify_db_password
            database "${arg2}"
            clean_temp_mycnf
            ;;
        *)
            show_usage
            ;;
    esac
}

# Run main function
main "$@"
